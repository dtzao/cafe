<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Escala de Café Operacional</title>

<style>
body{
    font-family: "Segoe UI", Arial, sans-serif;
    background:#f2f4f7;
    margin:0;
    padding:20px;
}
.assinatura{
    position:fixed;
    bottom:8px;
    right:12px;
    font-size:11px;
    color:#6c757d;
    opacity:0.7;
    font-family:"Segoe UI", Arial, sans-serif;
    pointer-events:none;
}

.assinatura-direita{ right:12px; }
.assinatura-esquerda{ left:12px; }

.container{
    max-width:1000px;
    margin:auto;
}
h1{
    text-align:center;
    margin-bottom:15px;
    color:#1f2d3d;
}
.topo{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:15px;
}
select, input[type="date"], button{
    padding:6px;
    font-size:14px;
}
button{
    cursor:pointer;
    background:#1f2d3d;
    color:#fff;
    border:none;
    border-radius:4px;
}
button:hover{
    background:#2f4158;
}
table{
    width:100%;
    border-collapse:collapse;
    background:#fff;
    border-radius:6px;
    overflow:hidden;
}
th, td{
    border:1px solid #ccc;
    padding:6px;
    text-align:center;
}
th{
    background:#1f2d3d;
    color:#fff;
}
.destacado{
    background:#fff3cd !important;
    font-weight:bold;
}
.ultimo-cafe{
    background:#ffcccc !important;
    font-weight:bold;
}
.turno-info{
    font-weight:bold;
    color:#1f2d3d;
}
</style>
</head>

<body>

<div class="container">

<h1>Escala de Café</h1>

<div class="topo">
    <strong>Data:</strong>
    <input type="date" id="dataEscala">

    <strong>Turno do serviço:</strong>
    <select id="turnoSelect">
        <option value="">-- Selecione --</option>
        <option>01h x 30min</option>
        <option>01h30 x 30min</option>
        <option>02h x 30min</option>
        <option>02h30 x 30min</option>
        <option>03h x 30min</option>
        <option>03h30 x 30min</option>
    </select>

    <button id="salvarTurno">Confirmar Turno</button>

    <strong>Destacar unidade:</strong>
    <select id="filtro">
        <option value="">-- Nenhum --</option>
    </select>
</div>

<div style="text-align:center;margin-bottom:10px;">
    <span class="turno-info" id="turnoAtual"></span>
</div>

<table>
<thead>
<tr>
    <th>Nº</th>
    <th>Início</th>
    <th>Fim</th>
    <th>Batalhão / Revezamento</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

</div>

<script>
// ===== CONFIGURAÇÃO =====
const inicio = 6*60 + 30;
const fim = 18*60 + 30;
const intervalo = 30;

// ===== UNIDADES =====
const unidades = [];
for(let i=1;i<=51;i++) unidades.push(`${i}º BPM/M`);
unidades.push(
    "1º DE TRÂNSITO",
    "2º DE TRÂNSITO",
    "BPCHOQUE",
    "BAEP CAPITAL",
    "BAEP METROPOLITANO",
    "REVEZAMENTO"
);

// ===== ELEMENTOS =====
const tabela = document.getElementById("tabela");
const filtro = document.getElementById("filtro");
const dataInput = document.getElementById("dataEscala");
const turnoSelect = document.getElementById("turnoSelect");
const salvarTurnoBtn = document.getElementById("salvarTurno");
const turnoAtualSpan = document.getElementById("turnoAtual");

// ===== DATA 2026 =====
dataInput.min = "2026-01-01";
dataInput.max = "2026-12-31";

const hojeISO = new Date().toISOString().split("T")[0];
dataInput.value = localStorage.getItem("dataCafe") || hojeISO;

// ===== BANCO =====
let bancoDias = JSON.parse(localStorage.getItem("escalaCafeDias")) || {};
let bancoTurnos = JSON.parse(localStorage.getItem("turnosCafe")) || {};
let escala = [];

// ===== FILTRO =====
unidades.forEach(u=>{
    const op=document.createElement("option");
    op.value=u;
    op.textContent=u;
    filtro.appendChild(op);
});

// ===== FUNÇÕES =====
function minParaHora(m){
    return String(Math.floor(m/60)).padStart(2,"0")+"H"+String(m%60).padStart(2,"0");
}

function carregarEscalaDoDia(data){
    escala = bancoDias[data] || [];
    tabela.innerHTML = "";

    let contador = 1;
    for(let t=inicio; t<fim; t+=intervalo){
        const tr=document.createElement("tr");
        if(t===18*60) tr.classList.add("ultimo-cafe");

        const salvo = escala[contador-1] || "";

        let options=`<option value="">-- Selecione --</option>`;
        unidades.forEach(u=>{
            options+=`<option ${u===salvo?"selected":""}>${u}</option>`;
        });

        tr.innerHTML=`
            <td>${contador}º</td>
            <td>${minParaHora(t)}</td>
            <td>${minParaHora(t+intervalo)}</td>
            <td><select data-index="${contador-1}">${options}</select></td>
        `;

        tabela.appendChild(tr);
        contador++;
    }

    carregarTurno(data);
    aplicarFiltro();
}

function carregarTurno(data){
    const turno = bancoTurnos[data];
    if(turno){
        turnoAtualSpan.textContent = `Turno do dia: ${turno}`;
        turnoSelect.value = turno;
    }else{
        turnoAtualSpan.textContent = "Turno do dia: não definido";
        turnoSelect.value = "";
    }
}

// ===== SALVAR ESCALA =====
tabela.addEventListener("change", e=>{
    if(e.target.tagName==="SELECT"){
        escala[e.target.dataset.index]=e.target.value;
        bancoDias[dataInput.value] = escala;
        localStorage.setItem("escalaCafeDias", JSON.stringify(bancoDias));
        aplicarFiltro();
    }
});

// ===== TURNO =====
salvarTurnoBtn.addEventListener("click", ()=>{
    if(!turnoSelect.value){
        alert("Selecione um turno antes de confirmar.");
        return;
    }

    const atual = bancoTurnos[dataInput.value];
    if(atual && atual !== turnoSelect.value){
        if(!confirm("Já existe um turno salvo para este dia. Deseja substituir?")){
            turnoSelect.value = atual;
            return;
        }
    }

    bancoTurnos[dataInput.value] = turnoSelect.value;
    localStorage.setItem("turnosCafe", JSON.stringify(bancoTurnos));
    carregarTurno(dataInput.value);
});

// ===== TROCA DE DIA =====
dataInput.addEventListener("change", ()=>{
    localStorage.setItem("dataCafe", dataInput.value);
    carregarEscalaDoDia(dataInput.value);
});

// ===== DESTAQUE =====
filtro.value = localStorage.getItem("filtroCafe") || "";

filtro.addEventListener("change", ()=>{
    localStorage.setItem("filtroCafe", filtro.value);
    aplicarFiltro();
});

function aplicarFiltro(){
    document.querySelectorAll("tbody tr").forEach(tr=>{
        tr.classList.remove("destacado");
        const sel=tr.querySelector("select");
        if(filtro.value && sel.value===filtro.value){
            tr.classList.add("destacado");
        }
    });
}

// ===== INICIAR =====
carregarEscalaDoDia(dataInput.value);
</script>

<div class="assinatura">
    Desenvolvido por SD PM 154.466-7 ANDERSON SILVA
</div>

<div class="assinatura">
    Desenvolvido por SD PM 154.466-7 ANDERSON SILVA
</div>

</body>
</html>
